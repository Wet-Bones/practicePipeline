pipeline{
	agent any

	environment {
		REGISTRY = "myContainerRegistry.azurecr.io"
		IMAGE_NAME = "flask-app"
		DOCKER_CREDENTIAL_ID = "acr-service-principal"
	}

	stages {
		stage('Clone repository') {
			steps {
				git 'https://github.com/Wet-Bones/practicePipeline.git'
			}
		}

		stage('Navigate to Subdirectory') {
			steps {
				dir('python_app')
			}
		}

		stage('Build Docker image') {
			steps {
				script {
					dockerImage = docker.build("${REGISTRY}/${IMAGE_NAME}:${BUILD_NUMBER}")
				}
			}
		}

		stage('Push Docker image to ACR') {
			steps {
				script {
					docker.withRegistry("https://${REGISTRY}", "${DOCKER_CREDENTIAL_ID}") {
						dockerImage.push()
					}
				}
			}
		}
	}
}
